services:
  # Infrastructure - etcd cluster (Raft consensus)
  etcd-1:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: mtls-etcd-1
    environment:
      ETCD_NAME: etcd-1
      ETCD_INITIAL_CLUSTER: etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-1:2379
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-1:2380
    networks:
      - mpc-network

  etcd-2:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: mtls-etcd-2
    environment:
      ETCD_NAME: etcd-2
      ETCD_INITIAL_CLUSTER: etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-2:2379
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-2:2380
    networks:
      - mpc-network

  etcd-3:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: mtls-etcd-3
    environment:
      ETCD_NAME: etcd-3
      ETCD_INITIAL_CLUSTER: etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd-3:2379
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd-3:2380
    networks:
      - mpc-network

  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: mtls-postgres
    environment:
      POSTGRES_USER: mpc
      POSTGRES_PASSWORD: mpc_password
      POSTGRES_DB: mpc_wallet
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - mpc-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mpc -d mpc_wallet"]
      interval: 10s
      timeout: 5s
      retries: 5

  # mTLS Nodes
  node-1:
    build:
      context: .
      dockerfile: docker/Dockerfile.node
    container_name: mtls-node-1
    environment:
      NODE_ID: 1
      LISTEN_ADDR: "0.0.0.0:9000"
      CA_CERT_PATH: /certs/ca.crt
      NODE_CERT_PATH: /certs/node1.crt
      NODE_KEY_PATH: /certs/node1.key
      BOOTSTRAP_PEERS: "172.18.0.22:9000,172.18.0.23:9000,172.18.0.24:9000,172.18.0.25:9000"
      ETCD_ENDPOINTS: "http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379"
      POSTGRES_URL: "postgresql://mpc:mpc_password@postgres:5432/mpc_wallet"
      TOTAL_NODES: 5
      THRESHOLD: 4
      RUST_LOG: info
    depends_on:
      postgres:
        condition: service_healthy
      etcd-1:
        condition: service_started
      etcd-2:
        condition: service_started
      etcd-3:
        condition: service_started
    volumes:
      - ./certs:/certs:ro
    networks:
      mpc-network:
        ipv4_address: 172.18.0.21
    ports:
      - "9011:9000"

  node-2:
    build:
      context: .
      dockerfile: docker/Dockerfile.node
    container_name: mtls-node-2
    environment:
      NODE_ID: 2
      LISTEN_ADDR: "0.0.0.0:9000"
      CA_CERT_PATH: /certs/ca.crt
      NODE_CERT_PATH: /certs/node2.crt
      NODE_KEY_PATH: /certs/node2.key
      BOOTSTRAP_PEERS: "172.18.0.21:9000,172.18.0.23:9000,172.18.0.24:9000,172.18.0.25:9000"
      ETCD_ENDPOINTS: "http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379"
      POSTGRES_URL: "postgresql://mpc:mpc_password@postgres:5432/mpc_wallet"
      TOTAL_NODES: 5
      THRESHOLD: 4
      RUST_LOG: info
    depends_on:
      postgres:
        condition: service_healthy
      etcd-1:
        condition: service_started
    volumes:
      - ./certs:/certs:ro
    networks:
      mpc-network:
        ipv4_address: 172.18.0.22
    ports:
      - "9012:9000"

  node-3:
    build:
      context: .
      dockerfile: docker/Dockerfile.node
    container_name: mtls-node-3
    environment:
      NODE_ID: 3
      LISTEN_ADDR: "0.0.0.0:9000"
      CA_CERT_PATH: /certs/ca.crt
      NODE_CERT_PATH: /certs/node3.crt
      NODE_KEY_PATH: /certs/node3.key
      BOOTSTRAP_PEERS: "172.18.0.21:9000,172.18.0.22:9000,172.18.0.24:9000,172.18.0.25:9000"
      ETCD_ENDPOINTS: "http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379"
      POSTGRES_URL: "postgresql://mpc:mpc_password@postgres:5432/mpc_wallet"
      TOTAL_NODES: 5
      THRESHOLD: 4
      RUST_LOG: info
    depends_on:
      postgres:
        condition: service_healthy
      etcd-1:
        condition: service_started
    volumes:
      - ./certs:/certs:ro
    networks:
      mpc-network:
        ipv4_address: 172.18.0.23
    ports:
      - "9013:9000"

  node-4:
    build:
      context: .
      dockerfile: docker/Dockerfile.node
    container_name: mtls-node-4
    environment:
      NODE_ID: 4
      LISTEN_ADDR: "0.0.0.0:9000"
      CA_CERT_PATH: /certs/ca.crt
      NODE_CERT_PATH: /certs/node4.crt
      NODE_KEY_PATH: /certs/node4.key
      BOOTSTRAP_PEERS: "172.18.0.21:9000,172.18.0.22:9000,172.18.0.23:9000,172.18.0.25:9000"
      ETCD_ENDPOINTS: "http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379"
      POSTGRES_URL: "postgresql://mpc:mpc_password@postgres:5432/mpc_wallet"
      TOTAL_NODES: 5
      THRESHOLD: 4
      RUST_LOG: info
    depends_on:
      postgres:
        condition: service_healthy
      etcd-1:
        condition: service_started
    volumes:
      - ./certs:/certs:ro
    networks:
      mpc-network:
        ipv4_address: 172.18.0.24
    ports:
      - "9014:9000"

  node-5:
    build:
      context: .
      dockerfile: docker/Dockerfile.node
    container_name: mtls-node-5
    environment:
      NODE_ID: 5
      LISTEN_ADDR: "0.0.0.0:9000"
      CA_CERT_PATH: /certs/ca.crt
      NODE_CERT_PATH: /certs/node5.crt
      NODE_KEY_PATH: /certs/node5.key
      BOOTSTRAP_PEERS: "172.18.0.21:9000,172.18.0.22:9000,172.18.0.23:9000,172.18.0.24:9000"
      ETCD_ENDPOINTS: "http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379"
      POSTGRES_URL: "postgresql://mpc:mpc_password@postgres:5432/mpc_wallet"
      TOTAL_NODES: 5
      THRESHOLD: 4
      RUST_LOG: info
    depends_on:
      postgres:
        condition: service_healthy
      etcd-1:
        condition: service_started
    volumes:
      - ./certs:/certs:ro
    networks:
      mpc-network:
        ipv4_address: 172.18.0.25
    ports:
      - "9015:9000"

volumes:
  postgres-data:

networks:
  mpc-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
